<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Directory of Services â€“ Orange Health Labs</title>

<link rel="icon" href="file.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --oh-orange: #ff6600;
  --oh-light: #fff7f2;
  --oh-border: #e3e3e3;
}

body {
  font-family: 'Inter', sans-serif;
  margin:0;
  color:#222;
}

/* ================= SCREEN HEADER ================= */
#header-wrap {
  padding:16px 20px 8px;
}
#header-wrap img {
  height:64px;
}
#main-title {
  font-size:30px;
  font-weight:700;
  color:var(--oh-orange);
  margin-top:6px;
}

/* ================= PRINT HEADER ================= */
#printHeader {
  display:none; /* hidden on screen */
}

/* ================= BUTTONS ================= */
#locationBtn {
  position:fixed;
  right:20px;
  top:50px;
  background:#333;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  font-weight:600;
}

#printBtn {
  position:fixed;
  right:20px;
  top:90px;
  background:var(--oh-orange);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  font-weight:600;
}

/* ================= FILTER BAR ================= */
#filters {
  position:sticky;
  top:0;
  background:#fff;
  border-bottom:2px solid var(--oh-orange);
  padding:12px 20px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

#filters input,
#filters select,
#filters button {
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--oh-border);
  font-size:14px;
  min-width:150px;
}

#filters button {
  background:var(--oh-orange);
  color:white;
  border:none;
  font-weight:600;
}

/* ================= TABLE ================= */
.dept-block {
  margin:28px 0 8px;
  padding:0 20px;
}
.dept-title {
  font-size:22px;
  font-weight:700;
  color:var(--oh-orange);
  border-bottom:3px solid var(--oh-orange);
  display:inline-block;
}
.table-wrap {
  padding:0 20px 25px;
}
table {
  width:100%;
  border-collapse:collapse;
}
th, td {
  padding:8px 10px;
  border-bottom:1px solid var(--oh-border);
  font-size:14px;
}
th {
  background:var(--oh-light);
  border-bottom:2px solid var(--oh-orange);
}
tr:nth-child(even) td {
  background:#fafafa;
}

/* ================= PRINT ================= */
@media print {

  /* ðŸ”» MUCH SMALLER PAGE TOP SPACE */
  @page {
    margin: 14mm 10mm 18mm 10mm;
  }

  /* Hide screen-only UI */
  #filters,
  #printBtn,
  #locationBtn,
  #header-wrap {
    display:none !important;
  }

  /* ===== PRINT HEADER (INLINE, COMPACT) ===== */
  #printHeader {
    display:flex;
    position:fixed;
    top:0;
    left:0;
    right:0;
    height:14mm;
    align-items:center;
    gap:10px;
    padding:4mm 10mm;
    border-bottom:2px solid var(--oh-orange);
    background:#fff;
    z-index:999;
  }

  #printHeader img {
    height:22px;
  }

  .print-title {
    font-size:14px;
    font-weight:700;
    color:var(--oh-orange);
    white-space:nowrap;
  }

  /* Push content just below header */
  #dosContainer {
    margin-top:16mm;
  }

  table {
    font-size:11px;
  }

  tr {
    page-break-inside:avoid;
  }

  /* ===== PRINT FOOTER ===== */
  body::after {
    content: "OHL BLR Koramangala";
    position:fixed;
    bottom:6mm;
    left:0;
    right:0;
    text-align:center;
    font-size:10px;
    font-weight:600;
    color:#666;
  }
}
</style>
</head>

<body>

<!-- PRINT HEADER -->
<div id="printHeader">
  <img src="logo.png" alt="Orange Health">
  <div class="print-title">Orange Health â€“ Directory of Services (DOS)</div>
</div>

<button id="locationBtn">OHL BLR Koramangala</button>
<button id="printBtn" onclick="window.print()">Print DOS</button>

<!-- SCREEN HEADER -->
<div id="header-wrap">
  <img src="logo.png" alt="Orange Health">
  <div id="main-title">Orange Health - Directory of Services (DOS)</div>
</div>

<div id="filters">
  <input id="searchBox" placeholder="Search test / investigation / method...">
  <select id="deptFilter"><option value="">Department: All</option></select>
  <select id="nablFilter">
    <option value="">NABL: All</option>
    <option value="yes">NABL: Yes</option>
    <option value="no">NABL: No</option>
  </select>
  <select id="cityFilter"><option value="">City: All</option></select>
  <button onclick="resetFilters()">Reset</button>
</div>

<div id="dosContainer"></div>

<script>
function formatFrequency(freq){
  const days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  return String(freq).split("").map((v,i)=>v==="1"?days[i]:"").filter(Boolean).join(" ");
}

function resetFilters(){
  searchBox.value="";
  deptFilter.value="";
  nablFilter.value="";
  cityFilter.value="";
  applyFilters();
}

fetch("data.json")
.then(r=>r.json())
.then(data=>{
  const grouped={};

  data.forEach(row=>{
    if(String(row.status).toLowerCase()!=="yes") return;
    const id=row.orange_test_id;

    if(!grouped[id]){
      grouped[id]={
        test_name:row.test_name,
        department:row.department,
        investigations:new Set(),
        methods:new Set(),
        sample:row.sample_name,
        container:row.vial_type,
        fasting:row.is_fasting_required,
        nabl:row.is_nabl_accredited,
        frequency:formatFrequency(row.testing_frequency),
        tat:row.lab_tat,
        lab:row.lab_name,
        city:row.city,
        price:row.price
      };
    }

    const inv = row.investigation_name && row.investigation_name.trim()
      ? row.investigation_name
      : row.test_name;

    grouped[id].investigations.add(inv);
    grouped[id].methods.add(row.method_description || row.name);
  });

  const tests=Object.values(grouped);

  [...new Set(tests.map(t=>t.department))].sort()
    .forEach(d=>deptFilter.add(new Option(d,d)));

  [...new Set(tests.map(t=>t.city))].sort()
    .forEach(c=>cityFilter.add(new Option(c,c)));

  window.applyFilters=function(){
    const q=searchBox.value.toLowerCase();
    const dept=deptFilter.value;
    const nabl=nablFilter.value.toLowerCase();
    const city=cityFilter.value;

    const byDept={};
    let rowNum=1;

    tests.forEach(t=>{
      if(dept && t.department!==dept) return;
      if(nabl && String(t.nabl).toLowerCase()!==nabl) return;
      if(city && t.city!==city) return;

      if(q && !(
        t.test_name.toLowerCase().includes(q) ||
        [...t.investigations].join().toLowerCase().includes(q) ||
        [...t.methods].join().toLowerCase().includes(q)
      )) return;

      (byDept[t.department]??=[]).push({...t,_rowNumber:rowNum++});
    });

    dosContainer.innerHTML="";

    Object.keys(byDept).sort().forEach(dep=>{
      dosContainer.insertAdjacentHTML("beforeend",
        `<div class="dept-block"><div class="dept-title">${dep}</div></div>`
      );

      const rows=byDept[dep].map(t=>`
        <tr>
          <td>${t._rowNumber}</td>
          <td>${t.test_name}</td>
          <td>${[...t.investigations].join(", ")}</td>
          <td>${[...t.methods].join(", ")}</td>
          <td>${t.sample}</td>
          <td>${t.container}</td>
          <td>${t.fasting}</td>
          <td>${String(t.nabl).toLowerCase()==="yes"?"Yes":"No"}</td>
          <td>${t.frequency}</td>
          <td>${t.tat}</td>
          <td>${t.lab}</td>
          <td>${t.city}</td>
          <td>${t.price}</td>
        </tr>`).join("");

      dosContainer.insertAdjacentHTML("beforeend",`
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Test Name</th><th>Investigations</th>
                <th>Methods</th><th>Sample</th><th>Container</th>
                <th>Fast</th><th>NABL</th><th>Freq</th>
                <th>TAT</th><th>Lab</th><th>City</th><th>â‚¹</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `);
    });
  };

  searchBox.oninput=applyFilters;
  deptFilter.onchange=applyFilters;
  nablFilter.onchange=applyFilters;
  cityFilter.onchange=applyFilters;

  applyFilters();
});
</script>

</body>
</html>
