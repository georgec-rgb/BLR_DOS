<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Directory of Services â€“ Orange Health Labs</title>

<link rel="icon" href="file.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --oh-orange:#ff6600;
  --oh-light:#fff7f2;
  --oh-border:#e3e3e3;
}

body {
  font-family: Inter, sans-serif;
  margin:0;
  color:#222;
}

/* ================= HEADER ================= */
#header-wrap {
  padding:16px 20px;
}
#header-wrap img { height:64px; }
#main-title {
  font-size:30px;
  font-weight:700;
  color:var(--oh-orange);
}

/* ================= FLOATING BUTTONS ================= */
#locationBtn {
  position:fixed;
  right:20px;
  top:50px;
  background:#333;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  font-weight:600;
}
#printBtn {
  position:fixed;
  right:20px;
  top:90px;
  background:var(--oh-orange);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  font-weight:600;
}

/* ================= FILTER BAR ================= */
#filters {
  position:sticky;
  top:0;
  background:#fff;
  border-bottom:2px solid var(--oh-orange);
  padding:12px 20px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  z-index:10;
}

#filters input,
#filters select,
#filters button {
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--oh-border);
  font-size:14px;
  min-width:150px;
}

#filters button {
  background:var(--oh-orange);
  color:white;
  border:none;
  font-weight:600;
}

/* ================= TABLE ================= */
.dept-block {
  padding:20px 20px 0;
}
.dept-title {
  font-size:22px;
  font-weight:700;
  color:var(--oh-orange);
  border-bottom:3px solid var(--oh-orange);
  display:inline-block;
}

.table-wrap {
  padding:10px 20px 30px;
}

table {
  width:100%;
  border-collapse:collapse;
}

th, td {
  padding:6px 8px;
  border-bottom:1px solid var(--oh-border);
  font-size:13px;
  vertical-align:top;
}

th {
  background:var(--oh-light);
  border-bottom:2px solid var(--oh-orange);
  font-weight:700;
}

/* ================= PRINT ================= */
@media print {

  @page { margin: 12mm; }

  #header-wrap,
  #filters,
  #printBtn,
  #locationBtn {
    display:none !important;
  }

  thead {
    display: table-header-group;
  }

  tr {
    page-break-inside:avoid;
  }

  table {
    font-size:11px;
  }

  .print-footer {
    position:fixed;
    bottom:8mm;
    left:0;
    right:0;
    text-align:center;
    font-size:9px;
    font-weight:600;
    color:#666;
  }
}
</style>
</head>

<body>

<div class="print-footer">OHL BLR Koramangala</div>

<button id="locationBtn">OHL BLR Koramangala</button>
<button id="printBtn" onclick="window.print()">Print DOS</button>

<!-- HEADER -->
<div id="header-wrap">
  <img src="logo.png" alt="Orange Health">
  <div id="main-title">Orange Health â€“ Directory of Services (DOS)</div>
</div>

<!-- FILTERS -->
<div id="filters">
  <input id="searchBox" placeholder="Search test / investigation / method...">
  <select id="deptFilter">
    <option value="">Department: All</option>
  </select>
  <select id="nablFilter">
    <option value="">NABL: All</option>
    <option value="yes">NABL: Yes</option>
    <option value="no">NABL: No</option>
  </select>
  <select id="cityFilter">
    <option value="">City: All</option>
  </select>
  <button onclick="resetFilters()">Reset</button>
</div>

<div id="dosContainer"></div>

<script>
function formatFrequency(freq){
  const days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  return String(freq).split("")
    .map((v,i)=>v==="1"?days[i]:"")
    .filter(Boolean)
    .join(" ");
}

function resetFilters(){
  searchBox.value="";
  deptFilter.value="";
  nablFilter.value="";
  cityFilter.value="";
  applyFilters();
}

fetch("data.json")
.then(r=>r.json())
.then(data=>{
  const grouped={};

  data.forEach(row=>{
    if(String(row.status).toLowerCase()!=="yes") return;

    const id=row.orange_test_id;

    if(!grouped[id]){
      grouped[id]={
        test_name:row.test_name,
        department:row.department,
        investigations:new Set(),
        methods:new Set(),
        sample:row.sample_name,
        container:row.vial_type,
        fasting:row.is_fasting_required,
        nabl:false,   // âœ… FIXED
        frequency:formatFrequency(row.testing_frequency),
        tat:row.lab_tat,
        lab:row.lab_name,
        city:row.city,
        price:row.price
      };
    }

    // âœ… NABL aggregation (ANY Yes â†’ Yes)
    grouped[id].nabl =
      grouped[id].nabl ||
      String(row.is_nabl_accredited).toLowerCase()==="yes";

    grouped[id].investigations.add(
      row.investigation_name?.trim() || row.test_name
    );
    grouped[id].methods.add(row.method_description || row.name);
  });

  const tests=Object.values(grouped);

  [...new Set(tests.map(t=>t.department))].sort()
    .forEach(d=>deptFilter.add(new Option(d,d)));

  [...new Set(tests.map(t=>t.city))].sort()
    .forEach(c=>cityFilter.add(new Option(c,c)));

  window.applyFilters=function(){
    const byDept={};
    let rowNum=1;
    const q=searchBox.value.trim().toLowerCase();

    tests.forEach(t=>{
      // ðŸ” SEARCH
      if(q){
        const haystack=`
          ${t.test_name}
          ${[...t.investigations].join(" ")}
          ${[...t.methods].join(" ")}
        `.toLowerCase();
        if(!haystack.includes(q)) return;
      }

      // ðŸ¥ DEPT
      if(deptFilter.value && t.department!==deptFilter.value) return;

      // ðŸ™ CITY
      if(cityFilter.value && t.city!==cityFilter.value) return;

      // ðŸ§ª NABL
      if(nablFilter.value){
        if(nablFilter.value==="yes" && !t.nabl) return;
        if(nablFilter.value==="no" && t.nabl) return;
      }

      (byDept[t.department]??=[]).push({...t,_rowNumber:rowNum++});
    });

    dosContainer.innerHTML="";

    Object.keys(byDept).sort().forEach(dep=>{
      dosContainer.insertAdjacentHTML("beforeend",
        `<div class="dept-block"><div class="dept-title">${dep}</div></div>`
      );

      dosContainer.insertAdjacentHTML("beforeend",`
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th colspan="13">
                  <div style="display:flex;align-items:center;gap:10px;">
                    <img src="logo.png" style="height:18px">
                    <span style="font-size:14px;color:#ff6600;font-weight:700;">
                      Orange Health â€“ Directory of Services (DOS)
                    </span>
                  </div>
                </th>
              </tr>
              <tr>
                <th>#</th><th>Test Name</th><th>Investigations</th>
                <th>Methods</th><th>Sample</th><th>Container</th>
                <th>Fast</th><th>NABL</th><th>Freq</th>
                <th>TAT</th><th>Lab</th><th>City</th><th>â‚¹</th>
              </tr>
            </thead>
            <tbody>
              ${byDept[dep].map(t=>`
                <tr>
                  <td>${t._rowNumber}</td>
                  <td>${t.test_name}</td>
                  <td>${[...t.investigations].join(", ")}</td>
                  <td>${[...t.methods].join(", ")}</td>
                  <td>${t.sample}</td>
                  <td>${t.container}</td>
                  <td>${t.fasting}</td>
                  <td>${t.nabl?"Yes":"No"}</td>
                  <td>${t.frequency}</td>
                  <td>${t.tat}</td>
                  <td>${t.lab}</td>
                  <td>${t.city}</td>
                  <td>${t.price}</td>
                </tr>`).join("")}
            </tbody>
          </table>
        </div>
      `);
    });
  };

  // âœ… FILTER EVENT BINDINGS
  searchBox.addEventListener("input", applyFilters);
  deptFilter.addEventListener("change", applyFilters);
  nablFilter.addEventListener("change", applyFilters);
  cityFilter.addEventListener("change", applyFilters);

  applyFilters();
});
</script>

</body>
</html>
